FROM quay.io/openshiftio/rhel-base-fabric8-analytics-worker:latest
LABEL maintainer "Devtools <devtools@redhat.com>"
LABEL author "Devtools <devtools@redhat.com>"

ENV LANG=en_US.UTF-8 \
    SCANCODE_PATH='/opt/scancode-toolkit/'

# Work-arounds & hacks:
# 'pip install --upgrade wheel': http://stackoverflow.com/questions/14296531
RUN pip3 install --upgrade 'pip>=10.0.0' && pip install --upgrade wheel && \
    pip3 install alembic psycopg2

# Install javascript deps
COPY hack/install_deps_npm.sh /tmp/install_deps/
RUN /tmp/install_deps/install_deps_npm.sh

# Install ScanCode-toolkit for license scan
COPY hack/install_scancode.sh /tmp/install_deps/
RUN /tmp/install_deps/install_scancode.sh

# Install dependencies required in both Python 2 and 3 versions
COPY ./hack/py23requirements.txt /tmp/install_deps/
RUN pip2 install -r /tmp/install_deps/py23requirements.txt
RUN pip3 install -r /tmp/install_deps/py23requirements.txt

# Install gofedlib needed for Go support
RUN pip2 install --egg git+https://github.com/gofed/gofedlib.git@18e0ce72d2c7bcbe3b19c20378f602633292eedf

# Create & set pcp dirs
RUN mkdir -p /etc/pcp /var/run/pcp /var/lib/pcp /var/log/pcp  && \
    chgrp -R root /etc/pcp /var/run/pcp /var/lib/pcp /var/log/pcp && \
    chmod -R g+rwX /etc/pcp /var/run/pcp /var/lib/pcp /var/log/pcp

# Not-yet-upstream-released patches
COPY hack/patches/* /tmp/install_deps/patches/
# Apply patches here to be able to patch selinon as well
RUN /tmp/install_deps/patches/apply_patches.sh
